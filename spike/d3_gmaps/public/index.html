<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
    <style type="text/css">

html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  /*fill: red;*/
  /*stroke: orange;*/
  stroke-width: 1.5px;
}

    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 3,
  center: new google.maps.LatLng(30.76487, -82.41948),
  mapTypeId: google.maps.MapTypeId.TERRAIN
});

// Load the station data. When the data comes back, create an overlay.

////////////////////////////////////////////////////////
// helper function to support json data
//   since we don't yet know how to restructure the incoming
//   d3 [data] object and how it translates to the [d] param
////////////////////////////////////////////////////////
//
// expected json format...
//
// "gtugiQAl01": [
//     {"link": "http://instagram.com/p/gtugiQAl01/"},
//     {"location": [-23.486559411, -46.607803339]},
//     {"likes": "0"},
//     {"created": "1384473831"},
//     {"thumbnail": "http://distilleryimage5.s3.amazonaws.com/68e14f824d8911e3b2cd128ee1f40433_5.jpg"}
// ],
//
////////////////////////////////////////////////////////

var J = (function(){
  // internal functions to grab data from the json structure
  var _link = function(j) { return j.value[0].link; }
  var _lat = function(j) { return j.value[1].location[0]; }
  var _long = function(j) { return j.value[1].location[1]; }
  var _likes = function(j) { return j.value[2].likes; }
  var _created = function(j) { return j.value[3].created; }
  var _thumbnail = function(j) { return j.value[4].thumbnail;}

  // public interface
  var f = {};

  f.link      = _link;
  f.lat       = _lat;
  f.long      = _long;
  f.likes     = _likes;
  f.created   = _created;
  f.thumbnail = _thumbnail;

  return f;
}());
// end of helper function to massage json data for d3
////////////////////////////////////////////////////////


d3.json("instagram.json", function(data) {

  // var clean_data = (function() {
  //   var cln = [];
  //   var dat = {};
  //   Object.keys(data).forEach(function(k){
  //     dat.id = k;
  //     dat.ig = data[k];
  //     cln.push(dat);
  //   });
  //   return cln
  // }());

  // console.log(clean_data);
  // data = clean_data;


  // debugger
  var overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
        .attr("class", "stations");

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      var projection = this.getProjection(),
          padding = 10;

      var marker = layer.selectAll("svg")
          .data(d3.entries(data))
          .each(transform) // update existing markers
        .enter().append("svg:svg")
          .each(transform)
          .attr("class", "marker");

      // Add a circle.
      marker.append("svg:circle")
          .attr("r", 4.5)
          .attr('fill', 'blue')
          .attr("cx", padding)
          .attr("cy", padding);

      // Add a label.
      marker.append("svg:text")
          .attr("x", padding + 7)
          .attr("y", padding)
          .attr("dy", ".34em")
          .text(function(d) { return d.key; });

      // Add a thumbnail (https://groups.google.com/forum/#!topic/d3-js/aQSWnEDFxIc)
      // marker.append("svg:image")
      //     .attr("xlink:href", "http://distilleryimage11.s3.amazonaws.com/3a80d5184d8411e38f7312f452da4cc0_5.jpg")
      //     .attr("width", 100)
      //     .attr("height", 100);

      // Add an event listener to the svg marker; methods like d3.mouse, d3.touches, d3.event, selection.on()
      // marker.on("click", console.log("hello little mouse"));
      // http://christopheviau.com/d3_tutorial/
      // https://groups.google.com/forum/#!topic/d3-js/kEqID1q3-2A
// I ended up sensing mouse move on map and calculating the mouse inside condition myself inside a separate function (mouseMove) using lat lng of mouse!

// var m = this;
// google.maps.event.addListener(m.map, 'mousemove', function(e) { m.mouseMove(e.latLng);});



      marker.append("svg:circle")
          .attr("r", 10)
          .attr('fill', 'purple')
          .attr("cx", padding)
          .attr("cy", padding)
          .on("mousedown", function() { d3.select(this).style("fill", "aliceblue"); })
          .on("mouseup", function() { d3.select(this).style("fill", null);
          });


      function transform(d) {
        d = new google.maps.LatLng(J.lat(d), J.long(d));
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
            .style("left", (d.x - padding) + "px")
            .style("top", (d.y - padding) + "px");
      }
    };
  };

  // Bind our overlay to the map…
  overlay.setMap(map);

  // we can change map settings after we look at the data as well
  //
  // var new_center = new google.maps.LatLng(30.76487, -182.41948);
  // map.center = new_center;
  // map.zoom = 12;
  // overlay.setMap(map);
});

    </script>
  </body>
</html>